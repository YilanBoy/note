---
layout: default
parent: PHP
nav_order: 3
---

# Joomla! XSS æ¼æ´ç ”ç©¶

å‰é™£å­ï¼Œåœ¨å…¨ä¸–ç•Œ CMS (Content Management System) å¸‚å ´æ“æœ‰ 2% å¸‚å ç‡çš„ Joomla è¢«ç™¼ç¾å«æœ‰ XSS (Cross-Site Scripting) æ¼æ´ã€‚ é€ æˆé€™å€‹æ¼æ´çš„åŸå› ä¸¦éæ˜¯ Joomla çš„ç¨‹å¼é‚è¼¯æœ‰ä»€éº¼å•é¡Œï¼Œè€Œæ˜¯ PHP æœ¬èº«æä¾›çš„å‡½å¼æœ‰ä¸€å€‹å¥‡æ€ªçš„ Bugã€‚

Joomla ä¸­æœ‰ä¸€å€‹ `Joomla\Filter\InputFilter` é¡åˆ¥ï¼Œç”¨ä¾†å°ä½¿ç”¨è€…çš„è¼¸å…¥é€²è¡Œ XSS éæ¿¾ï¼Œä¾‹å¦‚ç•¶ç”¨æˆ¶è¼¸å…¥ï¼š

```text
<script>alert('xss attack')</script>
```

ç¨‹å¼æœƒå°‡ HTML æ¨™ç±¤å¾è¼¸å…¥ä¸­ç§»é™¤ã€‚å› æ­¤è¼¸å‡ºæœƒæ˜¯ï¼š

```text
alert('xss attack')
```

XSS éæ¿¾çš„éƒ¨åˆ†ç¨‹å¼ç¢¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```php
// Is there a tag? If so it will certainly start with a '<'.
$tagOpenStart = StringHelper::strpos($source, '<');

while ($tagOpenStart !== false) {
    // Get some information about the tag we are processing
    $preTag .= StringHelper::substr($postTag, 0, $tagOpenStart);

    // ...
}
```

åœ¨é€™æ®µéæ¿¾ç¨‹å¼ç¢¼ä¸­ï¼Œç¨‹å¼æœƒå…ˆæ‰¾åˆ° `<` ç¬¦è™Ÿåœ¨å­—ä¸²ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œä¸¦åˆ©ç”¨è©²ç´¢å¼•ä½ç½®å°‡ `<` ç¬¦è™Ÿå‰çš„å­—ä¸²ä¿ç•™èµ·ä¾†ã€‚

ç¨‹å¼ç¢¼ä¸­çš„ `StringHelper::strpos()` èˆ‡ `StringHelper::substr()`ï¼Œ å…¶å¯¦æ˜¯ PHP å‡½å¼ `mb_strpos()` èˆ‡ `mb_substr()` çš„åŒ…è£ã€‚ ç°¡å–®èªªæ˜ä¸€ä¸‹ `mb_strpos()` èˆ‡ `mb_substr()` çš„åŠŸèƒ½ã€‚

`mb_strpos()` å¯ä»¥åœ¨ä¸€ä¸²å­—ä¸²ä¸­ï¼Œæ‰¾å‡ºæŒ‡å®šå­—å…ƒçš„ç´¢å¼•ä½ç½®ã€‚

```php
mb_strpos("abcdefg", "a"); // 0
mb_strpos("abcdefg", "b"); // 1
mb_strpos("abcdefg", "g"); // 6
```

`mb_substr` å¯ä»¥ç”¨ä¾†å–å¾—å­—ä¸²çš„ä¸€éƒ¨åˆ†ã€‚

```php
mb_substr("abcdefg", 0, 3); // "abc"
mb_substr("abcdefg", 0, 5); // "abcde"
```

Joomla æœƒå‡ºç¾ XSS æ¼æ´ï¼Œä¸»è¦åŸå› åœ¨æ–¼é€™å…©å€‹å‡½å¼é‡åˆ° UTF-8 å‰å°ä½å…ƒçµ„ (Leading Byte) æ™‚ï¼Œæœƒæœ‰ä¸ä¸€æ¨£çš„è™•ç†æ–¹å¼ã€‚

## ä»€éº¼æ˜¯å‰å°ä½å…ƒçµ„ (Leading Byte)ï¼Ÿ

å‰å°ä½å…ƒçµ„æŒ‡çš„æ˜¯**å¤šä½å…ƒçµ„å­—å…ƒç·¨ç¢¼ä¸­çš„ç¬¬ 1 å€‹ä½å…ƒçµ„**ã€‚åœ¨é€™äº›ç·¨ç¢¼ä¸­ï¼Œæ¯ 1 å€‹å­—å…ƒç”±å¤šå€‹ä½å…ƒçµ„çµ„æˆï¼Œå…¶ä¸­ç¬¬ 1 å€‹ä½å…ƒçµ„è¢«ç¨±ç‚ºå‰å°ä½å…ƒçµ„ï¼Œå¾Œé¢çš„ä½å…ƒçµ„å‰‡ç¨±ç‚ºé€£çºŒä½å…ƒçµ„ã€‚

å¸¸è¦‹çš„å¤šä½å…ƒçµ„å­—å…ƒç·¨ç¢¼æœ‰ UTF-8ï¼ŒUTF-8 å¯ä»¥ä½¿ç”¨ 1 è‡³ 4 å€‹ä½å…ƒçµ„ä¾†é¡¯ç¤ºä¸€å€‹å®Œæ•´çš„å­—å…ƒã€‚ä¾‹å¦‚å¾®ç¬‘çš„ emojiï¼Œç”¨åå…­é€²ä½çš„ä½å…ƒçµ„è¡¨ç¤ºå°±æ˜¯ `f0 9f 98 8a`ã€‚

```php
// åœ¨ UTF-8 ä¸­ï¼Œå¾®ç¬‘ emoji é€™å€‹å­—å…ƒç”±å››å€‹ä½å…ƒçµ„çµ„æˆ
// å¦‚æœæ¯å€‹ä½å…ƒä»¥ 16 é€²ä½è¡¨ç¤º
// ä¸‹é¢çš„ f0 å°±æ˜¯å‰å°ä½å…ƒçµ„ï¼Œå¾Œé¢çš„ 9fã€98 èˆ‡ 8a ç‚ºé€£çºŒä½å…ƒçµ„
var_dump("\xf0\x9f\x98\x8a" === 'ğŸ˜Š'); // bool (true)

// å¯ä»¥ä½¿ç”¨ bin2hex å°‡å­—å…ƒè½‰æ›æˆ 16 é€²ä½

echo bin2hex('ğŸ˜Š'); // f09f988a

// æˆ‘å€‘äººçœ¼çœ‹åˆ°çš„å¾®ç¬‘ emojiï¼šğŸ˜Š
// ç”¨ UTF-8 è¡¨ç¤ºç‚ºï¼šU+1F60A
// ç”¨äºŒé€²ä½è¡¨ç¤ºç‚ºï¼š11110000 10011111 10011000 10001010
// ç”¨åå…­é€²ä½è¡¨ç¤ºç‚ºï¼š0xf0 0x9f 0x98 0x8a
```

## Joomla XSS æ¼æ´èªªæ˜

èªªæ˜å®Œå‰å°ä½å…ƒçµ„ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹ Joomla çš„ XSS æ¼æ´æ˜¯å¦‚ä½•ç™¼ç”Ÿçš„ã€‚ç•¶ `mb_strpos()` åœ¨å­—ä¸²ä¸­è®€åˆ°å‰å°ä½å…ƒçµ„æ™‚ï¼Œå®ƒæœƒå˜—è©¦è§£æå¾Œé¢çš„é€£çºŒä½å…ƒçµ„ï¼Œç›´åˆ°è®€å–å®Œæ•´çš„ä½å…ƒçµ„åºåˆ—å¾Œæ‰æœƒèªçˆ²é€™æ˜¯ä¸€å€‹å®Œæ•´çš„å­—å…ƒã€‚

```php
mb_strpos("Hello! \xf0\x9f\x98\x8a How are you?", "ğŸ˜Š"); // 7
```

èªªåˆ°é€™è£¡ï¼Œè°æ˜çš„ä½ å¯èƒ½æœ‰ä¸€å€‹ç–‘å•ã€‚

å¦‚æœä½å…ƒçµ„åºåˆ—æ•…æ„ä¸çµ¦å®Œæ•´çš„å‘¢ï¼ŸğŸ¤”

å‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹åŒ…å«ä¸å®Œæ•´ä½å…ƒçµ„åºåˆ—çš„å­—ä¸² `\xf0\x9fAAA<BB`ï¼Œä¾†çœ‹çœ‹ `strpos()` æœƒæ€éº¼è™•ç†ã€‚

```text
\xf0 <- ç™¼ç¾å‰å°ä½å…ƒçµ„ï¼Œmb_strpos() é æœŸå¾Œé¢æœƒæœ‰ 3 å€‹é€£çºŒä½å…ƒçµ„ä¾†é¡¯ç¤ºä¸€å€‹å®Œæ•´çš„å­—å…ƒï¼Œè©²ä½å…ƒçµ„çš„ç´¢å¼•ç‚º 0
\x9f <- ç™¼ç¾é€£çºŒä½å…ƒçµ„ï¼Œæ­¤æ™‚è©²ä½å…ƒçµ„çš„ç´¢å¼•é‚„æ˜¯ç‚º 0ï¼Œå› ç‚ºå®Œæ•´çš„å­—å…ƒé‚„æ²’æœ‰å‡ºä¾†
A    <- ä¸æ˜¯é€£çºŒä½å…ƒçµ„ï¼ŒéŒ¯èª¤ï¼åœæ­¢è§£æé€£çºŒä½å…ƒçµ„ï¼Œä¸¦å°‡è©²å­—å…ƒçš„ç´¢å¼•è¨­ç‚º 1
A    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 2
A    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 3
<    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 4
B    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 5
B    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 6
```

å› æ­¤ç•¶æˆ‘å€‘æƒ³ä½¿ç”¨ `mb_strpos` åœ¨å­—ä¸² `\xf0\x9fAAA<BB` ä¸­å–å¾— `<` ç¬¦è™Ÿçš„ä½ç½®æ™‚ï¼Œçµæœç‚º 4ã€‚

```php
mb_strpos("\xf0\x9fAAA<BB", "<"); // 4
```

ä¸Šè¿°çš„åˆ¤æ–·é‚è¼¯å¥½åƒæ²’ä»€éº¼å•é¡Œï¼Œä½†æ˜¯ç•¶æˆ‘å€‘æƒ³ä½¿ç”¨ `mb_substr` ä¾†å–å¾— `<` ç¬¦è™Ÿå‰é¢çš„æ‰€æœ‰å­—æ™‚ï¼Œå°±æœƒå‡ºç¾å•é¡Œã€‚

å› ç‚º `mb_substr` å°æ–¼å‰å°ä½å…ƒçµ„çš„è™•ç†ï¼Œèˆ‡ `mb_strpos` å®Œå…¨ä¸åŒã€‚
`mb_substr` åªè¦é‡åˆ°å‰å°ä½å…ƒçµ„ï¼Œå°±æœƒç›´æ¥è·³éå¾Œé¢ä¸‰å€‹ä½å…ƒçµ„ã€‚

```text
\xf0 <- ç™¼ç¾å‰å°ä½å…ƒçµ„ï¼Œmb_substr é æœŸå¾Œé¢æœƒæœ‰ 3 å€‹é€£çºŒä½å…ƒçµ„ä¾†é¡¯ç¤ºä¸€å€‹å®Œæ•´çš„å­—ï¼Œè©²å­—ç¯€çš„ç´¢å¼•ç‚º 0
\x9f <- è·³éï¼è©²ä½å…ƒçµ„çš„ç´¢å¼•ç‚º 0
A    <- è·³éï¼è©²å­—å…ƒçš„ç´¢å¼•ç‚º 0
A    <- è·³éï¼è©²å­—å…ƒçš„ç´¢å¼•ç‚º 0
A    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 1
<    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 2
B    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 3
B    <- è©²å­—å…ƒçš„ç´¢å¼•ç‚º 4
```

å› æ­¤ç•¶æˆ‘å€‘åœ¨ `mb_substr` ä½¿ç”¨å‰é¢å–å¾—çš„ `<` ç¬¦è™Ÿä½ç½®ç´¢å¼•ã€‚æœƒæœ‰èˆ‡é æœŸå®Œå…¨ä¸åŒçš„çµæœã€‚

```php
// æˆ‘å€‘å¸Œæœ›å–å¾— "<" ç¬¦è™Ÿå‰é¢çš„å­—ä¸²ï¼Œä¹Ÿå°±æ˜¯ "\xf0\x9fAAA"
// å¯¦éš›ä¸Šçµæœå»æ˜¯ "\xf0\x9fAAA<B"ï¼Œ"<" ç¬¦è™Ÿä¸¦æ²’æœ‰è¢«æ’é™¤æ‰
mb_substr("\xf0\x9fAAA<BB", 0, 4);
```

å¯ä»¥çœ‹åˆ° `<` ç¬¦è™Ÿè¢«éæ¿¾æ©Ÿåˆ¶å¿½ç•¥äº†ï¼ŒXSS æ¼æ´ä¹Ÿå› æ­¤ç”¢ç”Ÿã€‚

> æœ€æ–°ç‰ˆæœ¬çš„ PHP èˆ‡ Joomla éƒ½å·²ç¶“ä¿®å¾©é€™å€‹æ¼æ´ã€‚

## åƒè€ƒè³‡æ–™

- [Joomla: PHP Bug Introduces Multiple XSS Vulnerabilities](https://www.sonarsource.com/blog/joomla-multiple-xss-vulnerabilities/)
